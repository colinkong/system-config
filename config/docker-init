#!/bin/bash
#
# Docker container init script
#

echo "Running \"$0\"..."

# Process plugins
for FILE in /etc/docker-init-*
do
    $FILE
done

# Switch to user $USER
if [ "$USER" ]
then
    export HOME=$(grep "^$USER:" /etc/passwd | cut -f6 -d:)
    cd $HOME
    if [ $# != 0 ]
    then
        echo "Starting \"$@\" app..."
        sudo -E -u $USER "$@"
        while [ "$(ps -fu $USER 2> /dev/null | grep "^$USER ")" ]
        do
            sleep 1
        done
    else
        echo "Starting \"$USER\" login shell..."
        sudo -E -u $USER bash -l
    fi
else
    echo "Starting \"root\" login shell..."
    /bin/bash -l
fi

echo "Finished \"$0\"..."
if [ "$$" = 1 ]
then
    echo "Stopping Docker container!"
fi
