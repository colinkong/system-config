#!/bin/bash

CONTAINER="sandbox"

export FLAGS="--volume=$PWD:$PWD --workdir=$PWD --network=none"
while [ $# -gt 0 ]
do
    case $1 in
    -32)
        CONTAINER="sandbox-i386"
        ;;
    -dri)
        FLAGS="$FLAGS --device=/dev/dri:/dev/dri"
        ;;
    -net)
        FLAGS="$FLAGS --network=bridge"
        ;;
    -snd)
        FLAGS="$FLAGS --device=/dev/snd:/dev/snd"
        ;;
    -x11)
        FLAGS="$FLAGS --volume=/tmp/.X11-unix:/tmp/.X11-unix --env DISPLAY=$DISPLAY --env XAUTH=\"$(xauth list $DISPLAY)\""
        ;;
    -*)
        echo "usage: $0 [-32] [-dri] [-net] [-snd] [-x11] [command]"
        echo
        echo "optional arguments:"
        echo "   -32         Select 32bit sandbox environment."
        echo "   -dri        Enable direct rendering device access."
        echo "   -net        Enable network device access."
        echo "   -snd        Enable sound device access."
        echo "   -x11        Enable X11 display access."
        exit 1
        ;;
    *)
        break
        ;;
    esac
    shift
done

export COMMAND="$@"

for FILE in ${0%/bin/docker-wine}/docker/Makefile $HOME/git/system-config/docker/Makefile
do
    if [ -f "$FILE" ]
    then
        exec make --quiet -C ${FILE%/*} run-$CONTAINER
    fi
done
echo "Error: Cannot locate \"git/system-config/docker/Makefile\""
exit 1
