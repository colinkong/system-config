#!/bin/bash

# Default sandbox environment
export DISTRO="ubuntu-18.04"

# Locate Sandbox Makefile
if [ -f "$(readlink -m "$0"/../..)/docker/Makefile" ]
then
    DIR="$(readlink -m "$0"/../..)"
elif [ -f "$HOME/git/system-config/docker/Makefile" ]
then
    DIR="$HOME/git/system-config"
else
    echo "Error: Cannot locate \"git/system-config/docker/Makefile\""
    exit 1
fi

# Share current working directory
export FLAGS="--volume=$PWD:$PWD --workdir=$PWD --network=none --user=$(id -u)"

# Default user
FLAGS="$FLAGS --volume=/etc/passwd:/etc/passwd:ro --user=$(id -u)"
for FILE in profile vimrc tmux.conf
do
    FLAGS="$FLAGS --volume=$DIR/config/$FILE:$HOME/.$FILE:ro"
done

while [ $# -gt 0 ]
do
    case $1 in
    -32)
        DISTRO="${DISTRO%-i386}-i386"
        ;;
    -dist=*)
        DISTRO=${1#*=}
        ;;
    -dri)
        FLAGS="$FLAGS --device=/dev/dri:/dev/dri"
        ;;
    -ipc)
        FLAGS="$FLAGS --ipc=host"
        ;;
    -net)
        FLAGS="$FLAGS --network=bridge"
        ;;
    -root)
        FLAGS="$FLAGS --user=0"
        ;;
    -snd)
        FLAGS="$FLAGS --device=/dev/snd:/dev/snd"
        ;;
    -v=*)
        MOUNT=${1#*=}
        FLAGS="$FLAGS --volume=${MOUNT%:ro}:$MOUNT"
        ;;
    -x11)
        FLAGS="$FLAGS --volume=/tmp/.X11-unix:/tmp/.X11-unix --env DISPLAY=$DISPLAY --env XAUTH=\"$(xauth list $DISPLAY)\""
        ;;
    -*)
        echo "usage: $0 [-32] [-dist=<name>] [-dri] [-net] [-root] [-snd] [-v=<path>[:ro]] [-x11] [command]"
        echo
        echo "optional arguments:"
        echo "   -32            Select 32bit sandbox environment."
        ls -1d $DIR/docker/*/sandbox/Makefile 2> /dev/null | sed -e "s@.*/docker/@   -dist=@;s@/.*@  Select sandbox environment.@"
        echo "   -dri           Enable direct rendering device access."
        echo "   -ipc           Enable shmem for internet process communications."
        echo "   -net           Enable network device access."
        echo "   -root          Run as root user."
        echo "   -snd           Enable sound device access."
        echo "   -v=<path>[:ro] Bind mount a volume (ie \"-v=/path\" & \"-v=/path:ro\")"
        echo "   -x11           Enable X11 display access."
        exit 1
        ;;
    *)
        break
        ;;
    esac
    shift
done

export COMMAND="$@"

if [ ! -f "$DIR/docker/$DISTRO/sandbox/Makefile" ]
then
     echo "Error: Cannot locate \"$DIR/docker/$DISTRO/sandbox/Makefile\""
     exit 1
fi

exec make --quiet -C $DIR/docker run-sandbox
