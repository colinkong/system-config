#!/bin/bash
#
# 32bit/64bit Wine sandbox (no net & x11 default)
#

# Locate GIT
if [ -f "$(readlink -m "$0"/../..)/docker/Makefile" ]
then
    DIR="$(readlink -m "$0"/../..)"
elif [ -f "$HOME/git/system-config/docker/Makefile" ]
then
    DIR="$HOME/git/system-config"
else
    echo "Error: Cannot locate \"git/system-config/docker/Makefile\""
    exit 1
fi

export FLAGS="--volume=$PWD:$PWD --workdir=$PWD --network=none"
while [ $# -gt 0 ]
do
    case $1 in
    -net)
        FLAGS="$FLAGS --network=bridge"
        ;;
    -x11)
        FLAGS="$FLAGS --volume=/tmp/.X11-unix:/tmp/.X11-unix --env DISPLAY=$DISPLAY --env XAUTH=\"$(xauth list $DISPLAY)\""
        ;;
    -*)
        echo "usage: $0 [-net] [-x11] [command]"
        echo
        echo "optional arguments:"
        echo "   -net        Enable network device access."
        echo "   -x11        Enable X11 display access."
        exit 1
        ;;
    *)
        break
        ;;
    esac
    shift
done

case ${1,,} in
*.bat|*.cmd)
    export COMMAND="wine cmd /c $@"
    ;;
cmd)
    export COMMAND="wine cmd"
    ;;
*.exe|*.msi)
    export COMMAND="wine $@"
    ;;
*)
    export COMMAND="$@"
    ;;
esac

exec make --quiet -C $DIR/docker run-wine
